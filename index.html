<html>
<head>
  <title>Лазорин Д.С., КС-21-04</tiltle>
<style type="text/css">
.info p {
  background: #31b0d5;
  margin 0;
  padding: 5px;
}

.container {
  width: 30em;
}

input {
  font-size: 16px;
  padding: 4px;
}

table {
  width: 100%;
}

td {
  padding: 0;
}
</style>
</head>
<body>
<section class="container">
  <h1>Автозаполнение</h1>
  <label for="city">Город / населенный пункт:</label><input id="city" name="city" type="text" />
  <br><br>
  <label for="address">Улица, дом, квартира:</label><input id="address" name="address" type="text" />
</section>
<script>
var token = "7fd18aaabd7d53ffa4846e4521c1f736c13490eb";

var type  = "ADDRESS";
var $city = $("#city");
var $address = $("#address") ;

function enforceCity(suggestion) {
  var sgt = $("#address").suggestions();
  sgt.clear();
  sgt.setOptions({
    constraints: {
      locations: { kladr_id: suggestion.data.kladr_id }
    },
    restrict_value: true
  });
}

function iplocate() {
  var serviceUrl = "https://suggestions.dadata.ru/suggestions/api/4_1/rs/iplocate/address";
  var params = {
    type: "GET",
    contentType: "application/json",
    headers: {
      "Authorization": "Token " + token
    }
  };
	return $.ajax(serviceUrl, params);
}

// город и населенный пункт
$city.suggestions({
  token: token,
  type: type,
  hint: false,
  bounds: "city-settlement",
  onSelect: enforceCity
});

$address.suggestions({
  token: token,
  type: type,
  hint: false,
  geoLocation: false
});

iplocate().done(function(response) {
    var location = response.location;
    console.log(location);
    if (!location) {
      return;
    }    
    $city.suggestions().setSuggestion(location);
    enforceCity(location);
});

</script>
</body>  
</html>
